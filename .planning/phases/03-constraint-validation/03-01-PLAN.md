---
phase: 03-constraint-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/constraint_checker.cpp
  - src/include/wz_extension.hpp
  - src/into_wz_function.cpp
autonomous: true

must_haves:
  truths:
    - "Source data with a nonexistent FK value (e.g., decKontoNr referencing a Konto that does not exist in tblKonto) is rejected before any INSERT executes -- zero rows written"
    - "The error message lists which FK column(s) failed and which specific values do not exist in the referenced MSSQL table"
    - "Source data with all valid FK values passes validation and inserts normally (no regression)"
    - "FK columns not present in source data are silently skipped -- no false failures"
    - "NULL values in FK columns are not treated as violations"
  artifacts:
    - path: "src/constraint_checker.cpp"
      provides: "Complete FK validation logic: value-existence checking against MSSQL referenced tables"
      contains: "ValidateForeignKeys"
    - path: "src/include/wz_extension.hpp"
      provides: "Updated function declaration for ValidateForeignKeys"
      contains: "ValidateForeignKeys"
    - path: "src/into_wz_function.cpp"
      provides: "FK validation call wired into pipeline between duplicate check and Vorlauf prep"
      contains: "ValidateForeignKeys"
  key_links:
    - from: "src/into_wz_function.cpp"
      to: "src/constraint_checker.cpp"
      via: "ValidateForeignKeys() call between Step 3 and Step 4"
      pattern: "ValidateForeignKeys"
    - from: "src/constraint_checker.cpp"
      to: "MSSQL referenced tables"
      via: "Attached database query using db_name.dbo.referenced_table"
      pattern: "db_name.*dbo"
    - from: "src/constraint_checker.cpp"
      to: "src/include/wz_utils.hpp"
      via: "FindColumnIndex for column name resolution"
      pattern: "FindColumnIndex"
---

<objective>
Complete the FK constraint validation layer so that `into_wz` validates foreign key references against MSSQL before any inserts execute. Source data with invalid FK values fails early with a clear error listing the violating columns and values. Zero rows are written on validation failure.

Purpose: Fulfills CST-01 and completes Phase 3 (the final phase). After this, all three pillars are in place: clean code, transactional inserts, and pre-insert validation.
Output: Working FK validation in constraint_checker.cpp, wired into IntoWzExecute pipeline.
</objective>

<execution_context>
@C:\Users\Ramon.Ljevo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Ramon.Ljevo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-constraint-validation/03-RESEARCH.md

@src/constraint_checker.cpp
@src/include/wz_extension.hpp
@src/into_wz_function.cpp
@src/include/wz_utils.hpp
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement FK validation in constraint_checker.cpp and update header</name>
  <files>src/constraint_checker.cpp, src/include/wz_extension.hpp</files>
  <action>
  **In `src/constraint_checker.cpp`:**

  1. **Remove `CheckDuplicatePrimanotaIds()`** (lines 74-107). This is dead code -- the actual duplicate checking is done by `CheckDuplicates()` in `into_wz_function.cpp`. Remove the entire function.

  2. **Fix `GetForeignKeyConstraints()` buffer overflow risk.** Replace the `char query_buffer[2048]` + `snprintf` pattern (lines 42-43) with `std::string` concatenation. The FK_QUERY_TEMPLATE already uses `%s` for table_name -- just build the query string directly:
     ```cpp
     string fk_query = string(FK_QUERY_TEMPLATE);
     // Replace %s with table_name (the template has one %s for table name)
     size_t pos = fk_query.find("%s");
     if (pos != string::npos) {
         fk_query.replace(pos, 2, table_name);
     }
     ```

  3. **Replace the existing `ValidateConstraints()` stub** with a new function `ValidateForeignKeys()`. The old function takes `DataChunk &data` which doesn't match the actual data model (`vector<vector<Value>>` in `bind_data.source_rows`). The new function signature:
     ```cpp
     bool ValidateForeignKeys(ClientContext &context,
                              const string &db_name,
                              const vector<vector<Value>> &source_rows,
                              const vector<string> &source_columns,
                              string &error_message);
     ```
     Returns `true` if validation passes (or no FK constraints found), `false` if violations detected (with `error_message` set).

  4. **Add a static helper `FindSourceColumnForFK()`** that maps MSSQL FK column names to source column names using the same fallback aliases as `BuildPrimanotaInsertSQL` in `into_wz_function.cpp`. The mapping must include:
     - `decKontoNr` -> try: `decKontoNr`, `konto`, `kontonr`, `konto_nr`, `account`
     - `decGegenkontoNr` -> try: `decGegenkontoNr`, `gegenkonto`, `gegenkontonr`, `gegenkonto_nr`, `counter_account`
     - `decEaKontoNr` -> try: `decEaKontoNr`, `eakonto`, `ea_konto`, `eakontonr`, `ea_konto_nr`
     Use `FindColumnIndex()` from `wz_utils.hpp` for each lookup (case-insensitive). If no alias matches, return `DConstants::INVALID_INDEX` to signal "skip this FK".

  5. **Add a static helper `CheckValueExistence()`** that checks which values from a set of distinct values exist in a referenced MSSQL table. Pattern:
     - Takes a `Connection &conn`, `db_name`, `ForeignKeyConstraint &fk`, `set<string> &distinct_values`, `vector<string> &missing_values`
     - Batches in groups of 100 (same as existing `CheckDuplicates()` pattern)
     - For each batch, builds query: `SELECT DISTINCT CAST(referenced_column AS VARCHAR) FROM db_name.dbo.referenced_table WHERE CAST(referenced_column AS VARCHAR) IN ('val1', 'val2', ...)`
     - Uses CAST AS VARCHAR on both sides to avoid type mismatch (Pitfall 2 from research)
     - Collects returned values into a `set<string>`, then compares against batch values to find missing ones
     - Uses `EscapeSqlString()` for each value in the IN clause (must add or use existing -- there's one in `into_wz_function.cpp`; add a local copy since it's a static function)
     - If query fails (e.g., referenced table doesn't exist), skip this constraint silently (don't fail the whole validation)
     - Iterates result using `Collection().Chunks()` pattern (same as existing code)

  6. **Implement `ValidateForeignKeys()` body:**
     - Call `GetForeignKeyConstraints(context, db_name, "tblPrimanota")` to discover FK constraints
     - If empty, return `true` (no constraints to validate, or metadata query failed)
     - Create a new `Connection` (same pattern as `CheckDuplicates` -- separate connection to avoid deadlock)
     - For each FK constraint:
       a. Call `FindSourceColumnForFK()` to find the source column index. If `INVALID_INDEX`, skip (source doesn't have this column).
       b. Collect distinct non-null values from `source_rows` for that column index into a `std::set<string>`. Filter out NULLs (Pitfall 5).
       c. If no distinct values, skip.
       d. Call `CheckValueExistence()` to find missing values.
       e. If missing values found, format a violation message: `"column_name: values [val1, val2, ...] not found in referenced_table.referenced_column"`. Show up to 10 values; if more, append `" (and N more)"`.
     - If any violation messages accumulated, set `error_message` to:
       ```
       "Foreign key validation failed:\n  - violation1\n  - violation2\n0 rows written."
       ```
       Return `false`.
     - Otherwise return `true`.

  7. **Add `#include "wz_utils.hpp"` and `#include <set>`** at the top of `constraint_checker.cpp` (for `FindColumnIndex` and `std::set`).

  **In `src/include/wz_extension.hpp`:**

  1. **Remove the `CheckDuplicatePrimanotaIds` declaration** (lines 68-71).
  2. **Remove the old `ValidateConstraints` declaration** (lines 63-66).
  3. **Add the new `ValidateForeignKeys` declaration:**
     ```cpp
     bool ValidateForeignKeys(ClientContext &context,
                              const string &db_name,
                              const vector<vector<Value>> &source_rows,
                              const vector<string> &source_columns,
                              string &error_message);
     ```
  4. Keep the `GetForeignKeyConstraints` declaration as-is (still needed internally and by ValidateForeignKeys).
  5. Keep `ForeignKeyConstraint` and `ConstraintViolation` structs as-is.
  </action>
  <verify>
  Run: `cmake --build build --config Release 2>&1 | tail -20`
  Expected: Build succeeds with no errors. No unresolved symbols for `ValidateForeignKeys`, `CheckDuplicatePrimanotaIds`, or `ValidateConstraints`.
  </verify>
  <done>
  - `constraint_checker.cpp` contains a working `ValidateForeignKeys()` that queries MSSQL referenced tables for value existence
  - `CheckDuplicatePrimanotaIds()` dead code is removed from both .cpp and .hpp
  - Old `ValidateConstraints()` stub is replaced with new `ValidateForeignKeys()` in both .cpp and .hpp
  - `GetForeignKeyConstraints()` uses std::string instead of snprintf buffer
  - Column name mapping covers `decKontoNr`, `decGegenkontoNr`, `decEaKontoNr` with all aliases from `BuildPrimanotaInsertSQL`
  - NULL values are filtered out before building IN clause
  - Value existence check is batched in groups of 100
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire FK validation into IntoWzExecute pipeline</name>
  <files>src/into_wz_function.cpp</files>
  <action>
  In `IntoWzExecute()` in `src/into_wz_function.cpp`, add a new validation step between Step 3 (duplicate check, line ~862) and Step 4 (Vorlauf prep, line ~869).

  Add this block after the duplicate check early-return and before the `// Step 4` comment:

  ```cpp
    // =========================================================================
    // Step 3.5: Validate foreign key constraints against MSSQL reference tables
    // =========================================================================

    if (!ValidateForeignKeys(context, bind_data.secret_name,
                             bind_data.source_rows, bind_data.source_columns, error_msg)) {
        AddErrorResult(bind_data, "ERROR", error_msg);
        OutputResults(bind_data, global_state, output);
        return;
    }
  ```

  This follows the exact same early-return error pattern as Steps 1-3. The `ValidateForeignKeys` function is already declared in `wz_extension.hpp` (which `into_wz_function.cpp` includes).

  No other changes to `into_wz_function.cpp`.
  </action>
  <verify>
  Run: `cmake --build build --config Release 2>&1 | tail -20`
  Expected: Build succeeds. The `ValidateForeignKeys` call resolves to the implementation in `constraint_checker.cpp`.

  Verify the pipeline order by searching for step comments:
  Run: `grep -n "Step [0-9]" src/into_wz_function.cpp`
  Expected output shows steps in order: 1, 2, 3, 3.5, 4, 5-7.
  </verify>
  <done>
  - `IntoWzExecute()` calls `ValidateForeignKeys()` between Step 3 and Step 4
  - Invalid FK values cause early return with error result before any INSERT executes
  - Valid FK values pass through to the existing insert pipeline unchanged (no regression)
  </done>
</task>

</tasks>

<verification>
1. Build succeeds: `cmake --build build --config Release` completes without errors
2. Pipeline order: `grep -n "Step" src/into_wz_function.cpp` shows steps 1, 2, 3, 3.5, 4, 5-7 in order
3. Dead code removed: `grep -rn "CheckDuplicatePrimanotaIds" src/` returns no results
4. Old stub removed: `grep -rn "ValidateConstraints" src/` returns no results (replaced by ValidateForeignKeys)
5. New function exists: `grep -rn "ValidateForeignKeys" src/` returns hits in constraint_checker.cpp, wz_extension.hpp, and into_wz_function.cpp
6. No snprintf in constraint_checker: `grep -n "snprintf" src/constraint_checker.cpp` returns no results
7. Column aliases present: `grep -n "konto\|gegenkonto\|eakonto" src/constraint_checker.cpp` shows the FK column alias mappings
</verification>

<success_criteria>
- Build compiles successfully with no errors
- ValidateForeignKeys() is implemented and wired into the pipeline at Step 3.5
- Dead code (CheckDuplicatePrimanotaIds, ValidateConstraints stub) is removed
- FK column mapping covers all aliases from BuildPrimanotaInsertSQL
- NULL values are excluded from validation
- Value existence checks are batched (100 per query)
- Error messages list violating column names and values
- Validation failure results in zero rows written (early return before any INSERT)
</success_criteria>

<output>
After completion, create `.planning/phases/03-constraint-validation/03-01-SUMMARY.md`
</output>
