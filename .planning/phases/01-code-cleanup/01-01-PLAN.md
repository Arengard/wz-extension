---
phase: 01-code-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/include/wz_utils.hpp
  - src/include/wz_extension.hpp
  - src/into_wz_function.cpp
  - CMakeLists.txt
  - src/primanota_mapper.cpp
  - src/vorlauf_builder.cpp
autonomous: true

must_haves:
  truths:
    - "primanota_mapper.cpp and vorlauf_builder.cpp no longer exist in the project"
    - "The build succeeds without the deleted files"
    - "FindColumnIndex exists in exactly one place (wz_utils.hpp) and is used by into_wz_function.cpp"
    - "Timestamp generation exists in exactly one place (wz_utils.hpp) and is used by into_wz_function.cpp"
    - "DeriveVorlaufBezeichnung exists in exactly one place (wz_utils.hpp) and is used by into_wz_function.cpp"
    - "VorlaufRecord, PrimanotaRecord, WzConfig structs are removed from wz_extension.hpp"
    - "ForeignKeyConstraint, ConstraintViolation, InsertResult structs remain in wz_extension.hpp"
  artifacts:
    - path: "src/include/wz_utils.hpp"
      provides: "Consolidated utility functions"
      contains: "FindColumnIndex"
    - path: "src/include/wz_extension.hpp"
      provides: "Trimmed header without dead declarations"
      contains: "ForeignKeyConstraint"
    - path: "CMakeLists.txt"
      provides: "Build config without dead files"
  key_links:
    - from: "src/into_wz_function.cpp"
      to: "src/include/wz_utils.hpp"
      via: "#include wz_utils.hpp"
      pattern: '#include "wz_utils.hpp"'
    - from: "src/into_wz_function.cpp"
      to: "DeriveVorlaufBezeichnung"
      via: "function call (was in vorlauf_builder.cpp, now in wz_utils.hpp)"
      pattern: "DeriveVorlaufBezeichnung"
---

<objective>
Remove dead files (primanota_mapper.cpp, vorlauf_builder.cpp), consolidate duplicated helper functions (FindColumnIndex, GetCurrentTimestamp, DeriveVorlaufBezeichnung) into a new wz_utils.hpp header, clean dead declarations from wz_extension.hpp, and update CMakeLists.txt.

Purpose: Eliminate dead code and duplication so the codebase only contains what matters, setting a clean foundation for the goto refactoring in Plan 01-02.
Output: A buildable project with wz_utils.hpp containing all shared helpers, two dead files deleted, and wz_extension.hpp trimmed of unused structs/declarations.
</objective>

<execution_context>
@C:\Users\Ramon.Ljevo\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\Ramon.Ljevo\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@C:\wz-extension\.planning\PROJECT.md
@C:\wz-extension\.planning\ROADMAP.md
@C:\wz-extension\.planning\STATE.md
@C:\wz-extension\.planning\phases\01-code-cleanup\01-CONTEXT.md
@C:\wz-extension\.planning\phases\01-code-cleanup\01-RESEARCH.md
@C:\wz-extension\.planning\codebase\CONVENTIONS.md

Source files to modify:
@C:\wz-extension\src\into_wz_function.cpp
@C:\wz-extension\src\include\wz_extension.hpp
@C:\wz-extension\CMakeLists.txt

Dead files to reference before deleting:
@C:\wz-extension\src\vorlauf_builder.cpp
@C:\wz-extension\src\primanota_mapper.cpp
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create wz_utils.hpp and update into_wz_function.cpp to use it</name>
  <files>
    src/include/wz_utils.hpp
    src/into_wz_function.cpp
  </files>
  <action>
Create `src/include/wz_utils.hpp` as a header-only utility file with these three inline functions inside `namespace duckdb {}`:

1. **FindColumnIndex** -- Case-insensitive column index lookup. Copy the implementation from `into_wz_function.cpp:205-217`. Signature: `inline idx_t FindColumnIndex(const vector<string> &columns, const string &name)`. Returns `DConstants::INVALID_INDEX` if not found. Needs `#include <algorithm>` for `std::transform`.

2. **GetCurrentTimestamp** -- MSSQL-formatted timestamp with centisecond precision. Copy from `into_wz_function.cpp:145-157`. Signature: `inline string GetCurrentTimestamp()`. Needs `#include <chrono>`.

3. **DeriveVorlaufBezeichnung** -- Derive Vorlauf description from date range. Inline the `ExtractMonthYear` logic directly (it only has one caller). Take the implementation from `vorlauf_builder.cpp:47-61` but inline the month/year parsing from `vorlauf_builder.cpp:31-41` directly into the function body (do not create a separate ExtractMonthYear). Signature: `inline string DeriveVorlaufBezeichnung(const string &date_from, const string &date_to)`.

Header guard: `#pragma once`
Required includes: `"duckdb.hpp"`, `<chrono>`, `<algorithm>`

Add a brief doc comment above each function (purpose + params).

Then update `src/into_wz_function.cpp`:
- Add `#include "wz_utils.hpp"` after the existing `#include "wz_extension.hpp"` line
- **Remove** the local `static string GetCurrentTimestamp()` function (lines 145-157)
- **Remove** the local `static idx_t FindColumnIndex()` function (lines 205-217)
- Do NOT remove any other functions -- everything else stays
- Verify that all calls to `FindColumnIndex`, `GetCurrentTimestamp`, and `DeriveVorlaufBezeichnung` in the file will resolve to the `wz_utils.hpp` versions (they are in the same `duckdb` namespace, so no qualification needed)

IMPORTANT: The `DeriveVorlaufBezeichnung` call at line 804 currently resolves from `vorlauf_builder.cpp`. After this task it must resolve from `wz_utils.hpp`.
  </action>
  <verify>
The project should build successfully. Run the build command from the project root. If no build environment is available, at minimum verify:
- `wz_utils.hpp` exists and contains all three functions
- `into_wz_function.cpp` includes `wz_utils.hpp`
- `into_wz_function.cpp` no longer has local `FindColumnIndex` or `GetCurrentTimestamp` definitions
- All calls to these functions in `into_wz_function.cpp` are still syntactically valid
  </verify>
  <done>
wz_utils.hpp contains FindColumnIndex, GetCurrentTimestamp, and DeriveVorlaufBezeichnung as inline functions. into_wz_function.cpp includes wz_utils.hpp and no longer defines its own copies of FindColumnIndex or GetCurrentTimestamp.
  </done>
</task>

<task type="auto">
  <name>Task 2: Delete dead files, clean header, update CMakeLists.txt</name>
  <files>
    src/primanota_mapper.cpp
    src/vorlauf_builder.cpp
    src/include/wz_extension.hpp
    CMakeLists.txt
  </files>
  <action>
**Delete files:**
- Delete `src/primanota_mapper.cpp` entirely
- Delete `src/vorlauf_builder.cpp` entirely

**Clean wz_extension.hpp:**
Remove the following dead items from `src/include/wz_extension.hpp`:

1. Remove the `WzConfig` struct (lines 24-30) -- only used by deleted files
2. Remove the `VorlaufRecord` struct (lines 36-52) -- only used by deleted files
3. Remove the `PrimanotaRecord` struct (lines 58-107) -- only used by deleted files
4. Remove the `BuildVorlaufFromData` function declaration (line 163-165) -- defined in deleted vorlauf_builder.cpp
5. Remove the `DeriveVorlaufBezeichnung` function declaration (line 167) -- now lives in wz_utils.hpp as inline, no declaration needed here
6. Remove the `MapDataToPrimanota` function declaration (lines 170-172) -- defined in deleted primanota_mapper.cpp

**KEEP these items (do not remove):**
- `WzExtension` class
- `ForeignKeyConstraint` struct
- `ConstraintViolation` struct
- `InsertResult` struct
- All constraint checker function declarations (`GetForeignKeyConstraints`, `ValidateConstraints`, `CheckDuplicatePrimanotaIds`)
- `RegisterIntoWzFunction` declaration
- All includes

Also remove the section comment headers for the deleted sections (e.g., "// Configuration structures", "// Vorlauf record structure", "// Primanota record structure", "// Vorlauf builder functions", "// Primanota mapper functions"). Keep the remaining section comment headers.

**Update CMakeLists.txt:**
Remove `src/vorlauf_builder.cpp` and `src/primanota_mapper.cpp` from the `EXTENSION_SOURCES` list. The result should be:
```cmake
set(EXTENSION_SOURCES
    src/wz_extension.cpp
    src/into_wz_function.cpp
    src/constraint_checker.cpp
)
```
  </action>
  <verify>
Verify:
- `src/primanota_mapper.cpp` does not exist
- `src/vorlauf_builder.cpp` does not exist
- `wz_extension.hpp` does not contain `WzConfig`, `VorlaufRecord`, `PrimanotaRecord`, `BuildVorlaufFromData`, `MapDataToPrimanota`
- `wz_extension.hpp` still contains `ForeignKeyConstraint`, `ConstraintViolation`, `InsertResult`, `RegisterIntoWzFunction`
- `CMakeLists.txt` lists exactly 3 source files: wz_extension.cpp, into_wz_function.cpp, constraint_checker.cpp
- No references to deleted files remain in any remaining source file (grep for "primanota_mapper" and "vorlauf_builder" across the src directory)
  </verify>
  <done>
Two dead files deleted. wz_extension.hpp contains only live declarations (constraint types, InsertResult, function registrations). CMakeLists.txt references only the 3 remaining source files. No broken references remain.
  </done>
</task>

</tasks>

<verification>
After both tasks:
1. `src/include/wz_utils.hpp` exists with 3 inline functions
2. `src/primanota_mapper.cpp` and `src/vorlauf_builder.cpp` do not exist
3. `CMakeLists.txt` has exactly 3 EXTENSION_SOURCES entries
4. `wz_extension.hpp` has no dead struct or function declarations
5. `into_wz_function.cpp` includes `wz_utils.hpp` and has no local duplicates of the consolidated helpers
6. Grep for "goto" in `into_wz_function.cpp` still shows gotos (those are Plan 01-02 scope, not this plan)
</verification>

<success_criteria>
- primanota_mapper.cpp and vorlauf_builder.cpp deleted from filesystem
- FindColumnIndex, GetCurrentTimestamp, DeriveVorlaufBezeichnung each exist in exactly one place (wz_utils.hpp)
- into_wz_function.cpp uses wz_utils.hpp versions of all three helpers
- wz_extension.hpp contains no declarations for deleted code
- CMakeLists.txt updated to remove dead files
- No broken references (grep confirms no mention of deleted files in remaining sources)
</success_criteria>

<output>
After completion, create `.planning/phases/01-code-cleanup/01-01-SUMMARY.md`
</output>
