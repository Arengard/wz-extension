name: Build DuckDB Extension (Multi-Platform)

on:
  push:
    branches:
      - '**'
  workflow_dispatch:

jobs:
  # ------------------------
  # 1️⃣ Build macOS Universal
  # ------------------------
  build-macos:
    name: Build macOS Extension
    runs-on: macos-latest
    strategy:
      matrix:
        arch: [x86_64, arm64]  # Build both Intel and Apple Silicon
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: true

      - name: Cache Homebrew packages
        uses: actions/cache@v3
        with:
          path: /usr/local/Homebrew/Library/Taps
          key: brew-cache-${{ runner.os }}-${{ matrix.arch }}
          restore-keys: brew-cache-${{ runner.os }}-

      - name: Install dependencies
        run: brew install cmake ninja

      - name: Build extension
        env:
          BUILD_UNITTESTS: 0
          BUILD_SHELL: 0
          ARCH: ${{ matrix.arch }}
        run: |
          mkdir -p build/${ARCH}
          cd build/${ARCH}
          cmake -G Ninja ../.. -DCMAKE_BUILD_TYPE=Release
          cmake --build . --config Release -j$(sysctl -n hw.ncpu)

      - name: Copy extension artifact
        run: |
          mkdir -p dist/${ARCH}
          cp build/${ARCH}/wz.duckdb_extension dist/${ARCH}/wz.duckdb_extension

  # ------------------------
  # 2️⃣ Merge macOS Universal Binary
  # ------------------------
  merge-macos-universal:
    name: Merge macOS Universal
    runs-on: macos-latest
    needs: build-macos
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Combine architectures
        run: |
          mkdir -p dist
          lipo -create \
            build/x86_64/wz.duckdb_extension \
            build/arm64/wz.duckdb_extension \
            -output dist/wz.duckdb_extension
          file dist/wz.duckdb_extension

      - name: Generate build info
        run: |
          GIT_SHA=$(git rev-parse --short HEAD)
          GIT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          BUILD_DATE=$(date -u +"%Y%m%d-%H%M%S")

          cat > dist/build-info.txt << EOF
Build Information
=================
Extension: WZ DuckDB Extension
Platform: macOS Universal
Git Branch: ${GIT_BRANCH}
Git Commit: ${GIT_SHA}
Build Date: ${BUILD_DATE}
EOF

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: wz-macos-universal-${{ github.sha }}
          path: dist/
          retention-days: 90

  # ------------------------
  # 3️⃣ Build Linux Extension
  # ------------------------
  build-linux:
    name: Build Linux Extension
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: true

      - name: Cache CMake build
        uses: actions/cache@v3
        with:
          path: build
          key: build-cache-linux-${{ github.sha }}

      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y cmake ninja-build build-essential

      - name: Build extension
        env:
          BUILD_UNITTESTS: 0
          BUILD_SHELL: 0
        run: |
          mkdir -p build
          cd build
          cmake -G Ninja ../
          cmake --build . --config Release -j$(nproc)
          mkdir -p dist
          cp wz.duckdb_extension dist/

      - name: Generate build info
        run: |
          GIT_SHA=$(git rev-parse --short HEAD)
          GIT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          BUILD_DATE=$(date -u +"%Y%m%d-%H%M%S")

          cat > dist/build-info.txt << EOF
Build Information
=================
Extension: WZ DuckDB Extension
Platform: Linux
Git Branch: ${GIT_BRANCH}
Git Commit: ${GIT_SHA}
Build Date: ${BUILD_DATE}
EOF

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: wz-linux-${{ github.sha }}
          path: dist/
          retention-days: 90

  # ------------------------
  # 4️⃣ Optional Release Creation
  # ------------------------
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [merge-macos-universal, build-linux]
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Download macOS artifact
        uses: actions/download-artifact@v3
        with:
          name: wz-macos-universal-${{ github.sha }}
          path: dist/macos

      - name: Download Linux artifact
        uses: actions/download-artifact@v3
        with:
          name: wz-linux-${{ github.sha }}
          path: dist/linux

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/macos/wz.duckdb_extension
            dist/macos/build-info.txt
            dist/linux/wz.duckdb_extension
            dist/linux/build-info.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
